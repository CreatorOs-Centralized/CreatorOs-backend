name: Build Services
on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - dev
      - main

jobs:
  build-profile-service:
    name: Build Profile Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/profile-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.yml exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.yml not found"
          fi

      - name: Set up JDK 21
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Profile Service
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

  build-content-service:
    name: Build Content Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/content-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.yml exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.yml not found"
          fi

      - name: Set up JDK 21
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Content Service
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

  build-auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/auth-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.yml exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.yml not found"
          fi

      - name: Set up JDK 17
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Auth Service
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

  build-asset-service:
    name: Build Asset Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/asset-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.yml exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.yml not found"
          fi

      - name: Set up JDK 17
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Asset Service
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

  build-publishing-service:
    name: Build Publishing Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/publishing-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.yml exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.yml not found"
          fi

      - name: Set up JDK 17
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Publishing Service
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

  build-scheduler-service:
    name: Build Scheduler Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/scheduler-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.yml exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.yml not found"
          fi

      - name: Set up JDK 17
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Scheduler Service
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gateway/api-gateway
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.yml exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.yml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.yml not found"
          fi

      - name: Set up JDK 17
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build API Gateway
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

  build-analytics-service:
    name: Build Analytics Service
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/analytics-service
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if application.properties exists
        id: check-config
        run: |
          if [ -f "src/main/resources/application.properties" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Skipping - application.properties not found"
          fi

      - name: Set up JDK 21
        if: steps.check-config.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build Analytics Service
        if: steps.check-config.outputs.exists == 'true'
        run: chmod +x ./gradlew && ./gradlew clean build -x test

